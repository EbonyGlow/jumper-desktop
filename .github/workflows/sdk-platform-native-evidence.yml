name: SDK Platform Native Evidence

on:
  workflow_dispatch:
  push:
    paths:
      - "flutter/packages/jumper_sdk_platform/windows/**"
      - "flutter/packages/jumper_sdk_platform/linux/**"
      - "flutter/packages/jumper_sdk_platform/macos/**"
      - "flutter/packages/jumper_sdk_platform/lib/**"
      - "flutter/packages/jumper_sdk_platform/example/integration_test/**"
      - ".github/workflows/sdk-platform-native-evidence.yml"

jobs:
  native-evidence:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            device: macos
            artifact_suffix: macos
            platform_arch: darwin-arm64
          - os: ubuntu-22.04
            device: linux
            artifact_suffix: linux
            platform_arch: linux-amd64
          - os: windows-2022
            device: windows
            artifact_suffix: windows
            platform_arch: windows-amd64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter 3.41.2
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.41.2"
          channel: stable
          cache: true

      - name: Install Linux desktop prerequisites
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev ninja-build

      - name: Prepare runtime assets for target platform
        shell: bash
        run: |
          chmod +x engine/runtime-assets/prepare-runtime-assets.sh
          ./engine/runtime-assets/prepare-runtime-assets.sh "${{ matrix.platform_arch }}" latest

      - name: Resolve runtime version
        id: runtime
        shell: bash
        run: |
          RUNTIME_VERSION="$(python3 - <<'PY'
          import json
          from pathlib import Path
          print(json.loads(Path('engine/runtime-assets/resolved-runtime-lock.json').read_text())['resolved_version'])
          PY
          )"
          echo "version=${RUNTIME_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Flutter pub get (example)
        working-directory: flutter/packages/jumper_sdk_platform/example
        run: flutter pub get

      - name: Run integration test on Linux
        if: runner.os == 'Linux'
        working-directory: flutter/packages/jumper_sdk_platform/example
        run: |
          set -o pipefail
          mkdir -p ../../../.artifacts/sdk-platform-native-${{ matrix.artifact_suffix }}
          xvfb-run -a flutter test integration_test/plugin_integration_test.dart -d linux \
            --dart-define=JUMPER_WORKSPACE_BASE_PATH="${{ github.workspace }}" \
            --dart-define=JUMPER_RUNTIME_VERSION="${{ steps.runtime.outputs.version }}" \
            2>&1 | tee ../../../.artifacts/sdk-platform-native-${{ matrix.artifact_suffix }}/native-evidence.log

      - name: Run integration test on macOS
        if: runner.os == 'macOS'
        working-directory: flutter/packages/jumper_sdk_platform/example
        run: |
          set -o pipefail
          mkdir -p ../../../.artifacts/sdk-platform-native-${{ matrix.artifact_suffix }}
          flutter test integration_test/plugin_integration_test.dart -d macos \
            --dart-define=JUMPER_WORKSPACE_BASE_PATH="${{ github.workspace }}" \
            --dart-define=JUMPER_RUNTIME_VERSION="${{ steps.runtime.outputs.version }}" \
            2>&1 | tee ../../../.artifacts/sdk-platform-native-${{ matrix.artifact_suffix }}/native-evidence.log

      - name: Run integration test on Windows
        if: runner.os == 'Windows'
        working-directory: flutter/packages/jumper_sdk_platform/example
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "..\..\..\.artifacts\sdk-platform-native-${{ matrix.artifact_suffix }}" | Out-Null
          flutter test integration_test/plugin_integration_test.dart -d windows `
            --dart-define=JUMPER_WORKSPACE_BASE_PATH="${{ github.workspace }}" `
            --dart-define=JUMPER_RUNTIME_VERSION="${{ steps.runtime.outputs.version }}" 2>&1 |
            Tee-Object -FilePath "..\..\..\.artifacts\sdk-platform-native-${{ matrix.artifact_suffix }}\native-evidence.log"
          if ($LASTEXITCODE -ne 0) {
            exit $LASTEXITCODE
          }

      - name: Write evidence summary
        if: always()
        shell: bash
        run: |
          ART_DIR="flutter/packages/.artifacts/sdk-platform-native-${{ matrix.artifact_suffix }}"
          mkdir -p "$ART_DIR"
          {
            echo "# SDK Platform Native Evidence"
            echo
            echo "- Runner OS: \`${{ runner.os }}\`"
            echo "- Device target: \`${{ matrix.device }}\`"
            echo "- Test: \`integration_test/plugin_integration_test.dart\`"
            echo "- Expected proof: \`runtimeMode == real\` for start/restart"
          } > "$ART_DIR/summary.md"

      - name: Publish summary
        if: always()
        shell: bash
        run: |
          ART_DIR="flutter/packages/.artifacts/sdk-platform-native-${{ matrix.artifact_suffix }}"
          if [ -f "$ART_DIR/summary.md" ]; then
            cat "$ART_DIR/summary.md" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload native evidence artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sdk-platform-native-evidence-${{ matrix.artifact_suffix }}-${{ github.run_id }}
          path: flutter/packages/.artifacts/sdk-platform-native-${{ matrix.artifact_suffix }}
